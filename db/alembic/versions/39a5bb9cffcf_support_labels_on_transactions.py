"""Support labels on transactions

Revision ID: 39a5bb9cffcf
Revises: ecb7817db377
Create Date: 2021-09-02 22:54:39.055168

"""
from alembic import op
import sqlalchemy as sa


# revision identifiers, used by Alembic.
revision = "39a5bb9cffcf"
down_revision = "ecb7817db377"
branch_labels = None
depends_on = None


def upgrade():
    # ### commands auto generated by Alembic - please adjust! ###
    op.add_column(
        "ethereum_labels",
        sa.Column("transaction_hash", sa.VARCHAR(length=256), nullable=True),
    )
    op.alter_column(
        "ethereum_labels", "address_id", existing_type=sa.INTEGER(), nullable=True
    )
    op.create_index(
        op.f("ix_ethereum_labels_transaction_hash"),
        "ethereum_labels",
        ["transaction_hash"],
        unique=False,
    )
    op.create_unique_constraint(
        op.f("uq_opensea_crawler_state_id"), "opensea_crawler_state", ["id"]
    )
    # ### end Alembic commands ###


def downgrade():
    # ### commands auto generated by Alembic - please adjust! ###
    op.drop_constraint(
        op.f("uq_opensea_crawler_state_id"), "opensea_crawler_state", type_="unique"
    )
    op.drop_index(
        op.f("ix_ethereum_labels_transaction_hash"), table_name="ethereum_labels"
    )
    op.execute("DELETE FROM ethereum_labels WHERE address_id IS NULL;")
    op.alter_column(
        "ethereum_labels", "address_id", existing_type=sa.INTEGER(), nullable=False
    )
    op.drop_column("ethereum_labels", "transaction_hash")
    # ### end Alembic commands ###
